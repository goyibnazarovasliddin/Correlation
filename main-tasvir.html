<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasvirlar Korrelatsiyasi</title>
    <style>
      body {
        background-color: aliceblue;
        display: flex;
        flex-direction: column;
        width: 100dvw;
        height: 100dvh;
        margin: 0;
        padding: 0;
      }

      .input {
        border: 2px dashed red;
        margin: 10px;
      }

      .input,
      .input-div {
        display: flex;
        align-items: center;
        flex-direction: column;
      }

      .input-div {
        flex-direction: row;
        gap: 20px;
        justify-content: space-between;
      }

      input {
        
      }
      .canvases {
        margin-top: 10px;
        border: 2px dashed red;
        display: flex;
        justify-content: center;
        gap: 30px;
        padding: 30px;
        height: 50%;
        margin: 10px;
      }

      canvas {
        border: 1px solid black;
        width: 50%;
        object-fit: fill;
      }

      .coef {
        border: 2px dashed red;
        margin: 10px;
        height: 50px;
        display: flex;
        align-items: center;
        padding: 20px;
        gap: 30px;
      }

      .coef h2:nth-child(2) {
        font-weight: 100;
      }
    </style>
  </head>
  <body>
    <div class="input">
      <div class="input-div">
        <h3>Birinchi rasmni yuklang:</h3>
        <input type="file" id="fileInput1" accept="image/*" />
      </div>
      <div class="input-div">
        <h3>Ikkinchi rasmni yuklang:</h3>
        <input type="file" id="fileInput2" accept="image/*" />
      </div>
    </div>

    <div class="canvases">
      <canvas id="canvas1"></canvas>
      <canvas id="canvas2"></canvas>
    </div>

    <div class="coef">
      <h2>Correllatsiyasi koeffitsiyentini hisoblash natijasi:</h2>
      <h2 id="correlationResult"></h2>
    </div>

    <script>
      document
        .getElementById("fileInput1")
        .addEventListener("change", function (event) {
          handleFileInput(event, "canvas1");
        });

      document
        .getElementById("fileInput2")
        .addEventListener("change", function (event) {
          handleFileInput(event, "canvas2");
        });

      async function handleFileInput(event, canvasId) {
        const file = event.target.files[0];
        if (file) {
          const img = await loadImage(URL.createObjectURL(file));
          const canvas = document.getElementById(canvasId);
          canvas.width = img.width;
          canvas.height = img.height;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0); // Yuklangan rasmni ekranga chizish

          if (canvasId === "canvas2") {
            const imgData1 = document
              .getElementById("canvas1")
              .getContext("2d")
              .getImageData(0, 0, canvas.width, canvas.height).data;
            const imgData2 = ctx.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            ).data;

            const correlation = calculateCorrelation(imgData1, imgData2);
            document.getElementById(
              "correlationResult"
            ).textContent = `Koeffitsiyent = ${correlation.toFixed(
              4
            )}`;
          }
        }
      }

      function loadImage(src) {
        return new Promise((resolve) => {
          const img = new Image();
          img.src = src;
          img.onload = () => resolve(img);
        });
      }

      function calculateCorrelation(data1, data2) {
        if (data1.length !== data2.length) return null;

        const n = data1.length / 4;
        let sumX = 0,
          sumY = 0,
          sumX2 = 0,
          sumY2 = 0,
          sumXY = 0;

        for (let i = 0; i < data1.length; i += 4) {
          const x = (data1[i] + data1[i + 1] + data1[i + 2]) / 3; // img1 yorqinligi
          const y = (data2[i] + data2[i + 1] + data2[i + 2]) / 3; // img2 yorqinligi

          sumX += x;
          sumY += y;
          sumX2 += x * x;
          sumY2 += y * y;
          sumXY += x * y;
        }

        let downCalc = Math.sqrt(
          Math.abs(n * sumX2 - sumX * sumX) * Math.abs(n * sumY2 - sumY * sumY)
        );

        return downCalc === 0 ? 0 : (n * sumXY - sumX * sumY) / downCalc;
      }
    </script>
  </body>
</html>
